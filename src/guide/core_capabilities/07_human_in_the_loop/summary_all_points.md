Source: `overview.md`, `human_in_the_loop.md`

## 人在回路（Human-in-the-loop, HITL）要点总览

**目标**：在智能体/工作流关键节点暂停，允许人类审阅、编辑、批准或补充信息，再恢复流程，提升安全性与可控性。

### 核心能力
- **持久化执行状态**：依赖 LangGraph 的持久化层（checkpoint）。每一步都会做快照，允许无限期暂停并在未来恢复。
- **两种暂停方式**：
  - 动态中断：在节点代码中调用 `interrupt(...)`，基于当前状态决定是否暂停。
  - 静态中断：在编译期或运行期指定 `interrupt_before` / `interrupt_after`，在固定节点前/后暂停（更适合调试）。
- **灵活集成点**：可在任意节点加入人类介入，用于审批外部调用、修正模型输出、补充上下文等。

### 通用流程（动态中断）
1) 在图上启用 `checkpointer`（如 `InMemorySaver`）。
2) 在节点中调用 `interrupt(payload)` 暂停执行，并将待审内容展示给人。
3) 以带有 `thread_id` 的配置运行图，直至命中中断。返回值中可见 `__interrupt__`。
4) 使用 `Command(resume=...)` 恢复，节点会从头重新执行，`interrupt(...)` 返回人类提供的值。

提示：`__interrupt__` 在 0.4.0 起在 `invoke/ainvoke` 中可见；更早版本仅在 `stream/astream` 时返回。

### 典型设计模式（Patterns）
- **审批（Approve / Reject）**：在敏感动作前暂停，请人类批准或拒绝，基于结果路由到不同分支。
- **编辑状态（Edit State）**：暂停以让人类审阅并编辑图的状态，然后继续下游处理。
- **审阅工具调用（Review Tool Calls）**：在工具执行前暂停，展示工具名与参数，允许人类批准、编辑或直接给出反馈；可在工具内部调用 `interrupt()`，也可用封装器为任意工具外挂 HITL。
- **校验人类输入（Validate Input）**：在一个节点内多次 `interrupt()` 实现校验循环，直到得到合法输入。

### 多并发中断一次恢复
并行执行的多个节点可能同时产生中断。可通过 `Command(resume={interrupt_id: value, ...})` 一次性恢复所有中断。

### 静态中断（用于调试）
- 在 `compile()` 时或 `invoke()` 运行时传入 `interrupt_before` / `interrupt_after` 以设置断点。
- 通过向图再次传入 `None` 输入继续执行到下一个断点。
- 不建议用于真正的 HITL 流程，仅用于单步调试与排障。

### 子图与父图的恢复语义
当子图中发生中断：
- 父图会从调用子图的那个父节点的开头重新执行；
- 子图会从包含 `interrupt(...)` 的那个子节点的开头重新执行；
- 已完成的上游节点不会重复执行（因已 checkpoint）。

### 重要注意事项
- 将有副作用的代码放在 `interrupt(...)` 之后，或拆分到独立节点，避免重复恢复时造成副作用重复触发。
- 单节点内多次 `interrupt(...)` 的恢复值按调用顺序匹配，运行间不要动态增删/重排 `interrupt(...)` 调用，以免索引错位导致非确定行为。

### 与代理/工具的结合
- 在工具内部直接调用 `interrupt(...)`，在执行工具前人审。
- 使用通用封装器为“任意”工具增加人审能力（与 Agent Inbox/Agent Chat UI 的约定格式兼容）。
- 运行代理时通过 `checkpointer` + `thread_id` 持久对话与中断恢复。

### 配置与恢复 API
- `interrupt(payload)`：暂停并返回 `Interrupt` 元数据；恢复后返回人类输入值。
- `Command(resume=...)`：用于恢复。并发中断可传“中断 ID 到值”的映射。
- `RunnableConfig`/`thread_id`：标识会话线程，保证多次调用属于同一条执行轨迹。

### 总结
HITL 通过“可暂停、可恢复”的执行模型，在关键决策点引入人类监督，兼顾安全性与效率。配合持久化、并发恢复、静态断点调试、子图语义与工具审阅等能力，可构建强健可控的生产级 LLM 工作流。


